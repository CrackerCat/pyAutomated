# -*- coding: utf-8 -*-
from os import error

from numba.cuda.decorators import convert_types
import Robot as rb
import time
import pytesseract as pytes
from utils import *
from tesserocr import RIL

'''
    
    while True:
        x,y = blRobot.findMultiColorInRegionFuzzy("0x202020","2|2|0x202020", 90, 52, 1131, 1024 ,1406)
        if x!=-1:
            print("posx:{0},posy:{1}".format(x,y))
            blRobot.click(x+1,y+1)
        else:
            print("not found")
'''



ditu = (
		"0007000000070000000700000007000000078000000fc0007ffffffe7fffffff7fffffff0007800e0007000e0007000e007f801c006780180067800000e7c00001c7f00001c7fc0001879e0003878700070707800e0701c01e0700e01c07007038070078780700387007001c0007001c0007000e00070006000300060000000000000000000000000000000000000000000e01c0100e03c0198e0780198e0700198e1e00198e3c00198e7800198ff80019dff80019fff80019ff99003ffe1980fffe1980fffe19c0f98e18e0198e1860198e1826198e1806198e1807198e1807198e1807198e1807198e1807198e7c0f198ffffe198e7ff8198e7c00198e1800188e1800000e1800000c100000000000000000000000000000000000000000001801e0061807c00e181f801c187e003819f80078180060e0380071e0f8003f80f8003f8018003f8018007f801800f78019ffe1e0187f00f0187f0078180f00101807800000000000000000000001c0007fffffff7ffffffe7c000078600000706000007060000070607c007871fe00787fffc0707c01f0e03800ffe0000000000000000000000000000000000000000000060006000e0006007e000e00f8001c3ff0001c7f0000387e0780701c0380e01801c1e01800e7801800ff801801fc001803f8001e0fc0001fff80000fc00000070000000000000000000000000000007ffffffe7ffffffe7ffffffe00f800000078000000380000001f0000000780000003f0000000700000003800$长寿郊外$1297$32$139",
        "001c0003180600038e0380038700e00781c0700f8070180f801c000f8004000e0000000e000000000100000001c1000000e1c0000070e00000387000001c3800000e1c0000070e00000387000003c3ffffffe1fffffff0e00000787000003c3800000e1c0000070e00000387000001c3800000e1c0000070e000003820000008000000000000000000000000000000000100000001c1ffffe0e1fffff871fffffc38e000001cf000000e7800c0073c38e0039e1c7001cf8e3800e7ff1c0073ff8e0039e3c7001cf0f3c03ff87ff03ffc3fffcffe1fffe7ff0fffe1e7879e0073c78e0039f7c7001cffe3800e7e71c0073e38e0c39e1c7061cf061838e780001c73c0000e38e0078f1c7fffff0e1fffff0607ffff0000000000000000000000000000000000000000003fff81039fffe181ce7ef0e0e61c1870630e0c3831878f1e38fffffffc7ffffffe3fffffff187861e78c3830e1c61e3870c3fffc38e1fffc0860fffe00100006000000030000000180008c70c000c6186000730f30003981fc001cc0fffffe60fffffe30ffffff186180000cf0c00007e0600003f031f801e01ff000600ff000000000000000000000000000000000000000000000003000300038001800fc001c00f8001c1ff8000e1fc0000e0fc0f00e01c0380e00c00e0f0060039e003001ff001801fc000c01fc000783f00003fff00000fc000000380000000000000000000000000000003fffffff1fffffff8fffffffc00f80000003c0000000e00000003e0000000780000001f80000001c0000000700@000$江南野外$1511$33$139",
        "0180000e0180001e0180001c0180003801800078018000f0018001e0018003c00180078001800f0001801e00018078000181f00007e7c000ffff8000ffff80007fff80000183e0000181f80001803c0001801e0001800700018003c0018001c0018000e001800070018000780180001c0180001e0180000e0100000e000000000000000000000000000000000000001c0ffffffe1fffffe03fffff80381c00003818000038180000399c63fe399c67fe399c6786399c6706399c6706399c6706799ce706799ce706fb9fe706ffffff06ffffff067fffe7063f9fe706399ee706399c6706399c6706399c6706399c6706399ce706399fe78639ffe7fe39ffc3fe38ff81fc381c00001008000000000000000000000000000000000000000000007ffffffe7ffffffe7ffffffe600000066000000660000086638001c6638101c6678381c6678381c6678381c6678381c6678381c6678781c667ffffc667ffffc667ffffc6678781c6678381c6678381c66783f1c66783f9c6638399c6638389c6630101c66000008660000006600001867ffffffe7ffffffe3ffffffc000000000000000000000000000000000000000000e0007001e000607fffffe07fffffe07fffffc001e0078000c00787000000070000000700c0000639e7fe0639e7fe0e39fffe1e39ffe79c3ffe67f83ffe67e03ffe67e079fe6700f9fe660079fe678079fe67f039fe67fc3ffe67fe3ffe67063ffe660739ffe60739fffe0739e7fe0739e7fc0600c0001e0000007e$大唐国境$1767$32$139",
        "0180000e0180001e0180001c0180003801800078018000f0018001e0018003c00180078001800f0001801e00018078000181f00007e7c000ffff8000ffff80007fff800001c3e0000181f80001803c0001801e0001800700018003c0018001c0018000e001800070018000780180001c0180001e0180000e0100000e000000000000000000000000000000000000001c0ffffffe1fffffe03fffff80381c00003818000038180000399c63fe399c67fe399c6786399c6706399c6706399c6706799ce706799ce706fb9fe706ffffff06ffffff067fffe7063f9fe706399ee706399c6706399c6706399c6706399c6706399ce706399fe78639ffe7fe39ffc3fe38ff81fc381c000010080000000000000000000000000000000000000000000000e0007001e000e07fffffe07fffffe03fffffc001e0078000c00307000000070000000700c0040639e7fe0639e7fe0e39fffe1e39ffe7bc3ffe67f83ffe67e03ffe67c079fe6700f9fe660079fe678079fe67f039fe67fc3ffe67fe3ffe67063ffe660639ffe60738fffe0738e7fe0730e7fc0600c0001e0000003e000000000000000000000000000000000000000000060006000e0006007e000e00f8001c3ff0001c7f0000387e0780701c0380e01801c1e01800e7801800ff801801fc001803f8001e0fc0001fff80000fc00000070000000000000000000000000000007ffffffe7ffffffe7ffffffe00f800000078000000380000001f0000000780000003f0000000700000003800$大唐境外$1531$32$139",
        "000002000000e38180007380c7f3ff8063ffff8231ffff0398c7ff01cc63ff80e63fffc0731fffe0398ffff81cc67ffffe631ffcf7318ffe1f98ffff0ffc7fff87fe3fffc3ff1fffe0ff8cfff01cc63ffc0e633fffc731ffffff98ffff01cc7fff80e631ffc07318ffe0398ffff81cc7ffff0661f03fc030f00e781800071c0c000104020000000000000000000000000000000000380000007e06187878030c383801861c1c01c70c0e61c3860730e387039861c701cc30c380e670e180733861c039f871c71cfc70c38e7e70e1df3ff0c0ff9ff86077ce7cf079e61ff8787303fff83981fff81cc0ff800e607f80073038e00398187801cc1c0e00e61c0780700e00e0380600781c02001c0fc0000703f0000381f80000c0000000000000000000000000000000000000038000e007c0007007c000780fc0003c0f00001e7f80001fffe001ffffffff3ffffffe01e7f00000f07c0000301e0000000380000001c00000000000010000000180000001e3800100f0f001c0383f00e01c03c0300e00f8180700000c0380000701c0000381e00001c0f00001cfffffffe3ffffffc03f0000000f00000003000000$墨家村$1342$33$104",
        "0067003800f3801c00f1c01e01f0e00e03f0700e03f8380f01f81c07000c0e070006070780030383800181c78000c0f38000607fc0007c3ff001fffffff9fffffffeffffffff0383fc000181fe0000c0f380006070e00030383800181c1e000c0e0700060701c0030380f00181c03800c0e00e0060700780003801c0000c006000000000000000000000000000000000000000000001e00060ffe00030fff006380070071c00187f9c000c3fce000e3fe607ff3fff0fff9fff80f3ffff8071ffff1838ffff0e187e7f870c3f3fc3c61f1fffc0000fffe000067fe7fe073c03ffc39c0038f38e00183986000c1cc3300606019c030300c6018183e181c0c1f0c0c0e0787060f01e1800f0078e00f800c3007800408000000000000000000000000000000000000000007ffffffe3fffffff1fffffff8c000000c600000063000004318e000718c702038c678381c633c1c0e319e0e0718cf07038c678381c633c3c0e319fffff18cfffff8c67ffffc633c3c0e319e0e0718cf07038c6383f1c631c1fce318e0e6718c707138c630101c630000043180000018c000038c7ffffffe3fffffff0fffffff@000$朱紫国$1309$33$103",
        "0000007f1ffffffe3fffffc07fffff807beffff879e7fffe7fff8706ffff8606f9c78606f18386067ffffffe7ffffffe79c7860671c7860671ff060620ff060000000200080002001c0006033ffffe0f7ffffe3e7ffffefc1c71c67818718660187186001c7186001c71c6001e79c6703ffffe787ffffe1e1c00060e18000206000000000000000000000000000000000000003f3fffffff7fcfffe07f87ff807ffffffc7fffdffeffff8606ff8786067fff86067ffffffe7fc7fffe61879ffe61ff060661ff0606009e0706000e0786010e0f86639fff867b98f1dc3b9861f803e07ff003e07fe00ff83fc0fffc3f803ffc3ff00ff03ff81ff878781ff878383f98fcfc7999ffff018c787801003038000000000000000000000000000000000000000003fffff803fffffc03fffffe0000000e0000000600000006000000060000000600000006000000060000000600000006000000060000001e7ffffffe7ffffffe7ffffffe0000000e0000000600000006000000060000000600000006000000060000000600000006000000060000001e03fffffe03fffffc01fffff8$麒麟山$1429$32$104",
        "18001c000c001e0006001e0003001f0001803fc000c07ffff8e1fffffdfce00000ffe000001e0000000e00000003000180018001c000c000e0006000700030007e00187ffffe0c1fffff06007e078f803c00cff00e0073f00e0039f007001c3007000c180700060c0380030603800183008001c180000fe0c0000fe0400007e0000000000000000000000000000000000000000080000380e00001c070ffe0e070fff870307ffe381831c71c1c18e18e1c0c70c70c0638638e031c31c6018e18e600c70c7f0063863f803befffe01fffffffefffffffe7fffffc031c73fc018e18fe00c70c7300638639c031c31c6018618e380c30c70e06386387833ef1c1c1fff0e0e07ff070381ff0381e00001c0f0000040300000000000000000000000000000000000000000003fffff801fffffe00ffffff80000001c00000006000000030000000180000000c00000006000000030000000180000000c000000060000000f1fffffff8fffffffc7ffffffe000000070000000180000000c00000006000000030000000180000000c00000006000000030000000180000003c03fffffe01fffffe007ffffe@000$花果山$1052$33$103",
        "0300000000c0000200300001c00c0000700300e03800c0781c00307f0e000fffc70003fff3c001fc3cc001fe0f0031fc03c00c7f00f00380c03c00e0300f00380c03c00e0301f80f80c3ffffc030ffffe00c03c0000300f00000c03c0000300f00000c03c0000300f1c000c03c3800300f0f000c03c1e00300603c00c0000700300000c000000000000000000000000000000000000000000c203c000f0c07000f0380e01fc070181f001c02078000000000000c0200000701c00003c0f3f001e03ffc01f03fff01f1ffc0c07c7ff0300f3c3c0c03cf070300f381c0c03ce0fc300f3c3f8cc3cfcff338f3ffccce3cfff133cf38fc0cf3ce1f033cf383c0ff3ce0f03f8f383e1fc3cf0ffff0f3ffffe03c7ffc3006003c0c0180060100000000000000000000000000000000000000400000303c000f8e07000f83c0e03fc070383f000c063f80000000000000000000000000000038c7e3061c33f8c3fe0cfe30f0033f8c3c00cce30f003338c3ff8cce30fff7338e3fffcce39f003338efc00cce39f003338e3c00cce38f003338e3fffcce38ffe3338e3c00cce38f003338e3c00cce38f003f3cc1fe0fcff001c0e1f80038003c@00$东海湾$1198$34$103",
        "00010000000f0000003f800000fffffe1fffffffff81c000fe0000001c0100061801800f1c61803e1c6187fc1c61ffe01ee3ff803fff9e00ffff8e073fff8e071ee38e071e618f3e1c6187fe1803800408070000007e000600fe001e07ff003e7fffc07c3e03f8f00e01ffe006007fe006003fe00701f87007fff07c07f8001e0700000e000000000000000000000000000000000000000c0001801c00018018180180181c0180381c0180701f8180e01fe181e01c7981c0187f838018018700180186001801fc001c01fc003e03fe007ffffffe7ffffffe7ffffffe1c01fe001801fc001801ce0018018700180183801c3f81c01e7981c01ff180e01f8180701e0180381c018018080180180001801c0000800c00000000000000000000000000000000000000007ffffffe7ffffffe7ffffffe600000066000000660000086638001c6638101c6678381c6678381c6678381c6678381c6678381c6678781c667ffffc667ffffc667ffffc6678781c6638381c6638381c66383f1c66383f9c6638399c6638389c6630101c66000008660000006600001c67ffffffe7ffffffe3ffffffc$傲来国$1286$32$105",
        "2060000078e038061fe070071fe070063ffffc3e7ffffffcf801ffc0f000fe00001ffe0007fffc0003fff80003fff01f03fffe7c3ffffff8ffffff80ffffff006000000060000000603ffff060fffff860e0000061e000007bf000007ffffffe7ffffffe7ffffffe71e0003861e0001860e0007860fffff8607ffff0207fffe00000000000000000000000000000000000000000600f038060ff838067ff87806001870060018706600187066001860760078607607f86077fff80077fffc01e3c01fffe0000fffc0f0000000fc000001fe000001e1ffff81c1ffffc181ffffe180070061800600638006006f800e0067800c0063801c00618038006180780061c07000e1e06003e1fc001fc0fc001f8000000000000000000000000000000000000000007fffff00000fff00000007803fffff87ffffff87ffffff87ffffff8000000780000007803fffff807fffff001e0000001c000000180000003806000070060000e0060e01c0060603800607070006070e0606078e0706078e038607c701860fe381861fe1c0063870e00678307007e0003807e000180700001c00000$狮驼岭$1261$32$104",
)

tu_text_features = ['图','T']
shop_emty = (727,651,"0x3f4a53"),(663,644,"0x3f4a53"),(623,645,"0x3f4a53"),(720,616,"0x3f4a53"),(718,683,"0x3f4a53"),(797,679,"0x3f4a53"),(855,675,"0x3f4a53"),(852,637,"0x3f4a53")
tu_money = 27999

feixingfu_jiemian = (1309,382, '0x0c5a9b'),(839,272, '0x1064a7'),(689,370, '0x1367a9'),(814,536, '0x166baa'),(927,669, '0x1160a0'),(1138,597, '0x196ca6'),(1432,674, '0x0c4e95'),(755,423, '0xe879aa'),(1165,550, '0xf0ce08'),(770,292, '0xebf200')

class action(rb.Robot):

    def __init__(self,class_name="subWin",title_name="sub",zoom_count=1.5):
        rb.Robot.__init__(self,class_name=class_name,title_name=title_name,zoom_count=zoom_count)
        self.Get_GameHwnd()
        self.cx = None
        self.error = list()
        
    def find_map_by_shop(self):
        tpl = self.Print_screen()
        start_pos = [285,196,532,244] #第一个摊位
        conversion = [285,196,532,244]
        #self.show(tpl)
        tu_shop = list()
        xret = list()
        jump = False
        xret.clear()
        for i in range(0,5):
            if jump:
                break
            conversion[1] = start_pos[1] + i*144
            conversion[3] = start_pos[3] + i*144
            for j in range(0,4):
                conversion[0] = start_pos[0] + j*341
                conversion[2] = start_pos[2] + j*341
                #print("conversion{0}".format(conversion))
                e_shop_emty = self.findMultiColorInRegionFuzzyByTable(shop_emty,90,conversion[0],conversion[1],conversion[2],conversion[3])                
                if e_shop_emty[0] == State.OK:
                    print("发现空摊位")
                    jump = True
                    break
                tu_shop = self.tsOcrText(tpl,tu_text_features,conversion[0],conversion[1],conversion[2],conversion[3]) 
                if len(tu_shop):
                    print("ret:{0}".format(tu_shop))
                    xret.append(tu_shop[0])
        return xret
    
    def buy_map(self):
        #点击系统界面
        self.click(673,1025)
        time.sleep(2)
        self.click(1260,729)
        time.sleep(2)
        tpl = self.Print_screen()
        max_page = int(self.OcrText(tpl,1411, 921, 1447, 962,config=('--oem 1 -l chi_sim --psm 7 '))[0][0])
        print(max_page)
        for i in range(1,max_page+1):
          shop_pos_list = self.find_map_by_shop()
          if len(shop_pos_list):
             print("发现摊位坐标:{0}".format(shop_pos_list))
             for j in shop_pos_list:
                x = j[1]
                y = j[2]
                print("点击摊位坐标:({0},{1})".format(x,y))
                self.click(x,y)
                time.sleep(2)
                self.click(1700,82)
                time.sleep(2)
          if i >= max_page:
                continue
          else:
                print("点击下一页")   
                self.click(1549,937) 
                time.sleep(2)
                
    
    def run_with_callback(self,fun,fun_param,pre_fun1,fun1_param,post_fun2,fun2_param):
        try:
            print("start pre_fun1")
            ret = pre_fun1(fun_param)
            ret = fun(ret,fun1_param)
            ret = post_fun2(ret,fun2_param)
            self.cx = ret
        except Exception as identifier:
            self.error.append(identifier)
    '''
    在各主城增加了仓库管理员NPC，坐标分别为：长安城（346，244）、长安城（224，141）、建邺城（54，32)、傲来国（143，101）、长寿村（111，62）、朱紫国（126，90）
    '''
    #check_map 打开道具栏遍历宝图
    def check_map(self):
        n,nn,nnn,nnnn=None,None,None,None
        #打开道具栏
        self.click(1695,1015)
        time.sleep(1)
        tpl = self.Print_screen()
        target = cv2.imread("./images/tu.png")
        start_pos = (902,269,1013,378)
        convert_pos = [902,269,1013,378]
        tu_list = list()
        for i in range(0,5):
            time.sleep(0.5)
            convert_pos[0] = start_pos[0] + i*134
            convert_pos[2] = start_pos[2] + i*134
            for j in range(0,4):
                time.sleep(0.5)
                print(j)
                convert_pos[1] = start_pos[1] + j*134
                convert_pos[3] = start_pos[3] + j*134
                self.click(convert_pos[0]+5,convert_pos[1]+5)
                time.sleep(0.5)
                tpl = self.Print_screen()
                #self.show(tpl[convert_pos[1]:convert_pos[3],convert_pos[0]:convert_pos[2]])
                x,y = self.matchTemplate(tpl[convert_pos[1]:convert_pos[3],convert_pos[0]:convert_pos[2]],target,0.15)
                if x != -1:
                    print("找到宝图")
                    data = self.x_Ocrtext(ditu,"00E804,011805#03DC07,032006#08DD0B,072009",444,506,589,560)
                    print(data)
                    if data:
                        if len(data)>3:
                            pos = self.Ocrtext("06BE0B,06420B#00E804,011805#03DC07,032006#08DD0B,072009",
                                               591,511,732,547,ril=RIL.TEXTLINE,
                                               lang='eng',oem=1,
                                               attribute=["tessedit_char_whitelist", 
                                                "0123456789,"])
                            print(pos)
                            _x = int(pos['text'].split(',')[0])
                            _y = int(pos['text'].split(',')[1])
                            tu_list.append((data,_x,_y))
                        else:
                            pos = self.Ocrtext("06BE0B,06420B#03E105,031E05#00E804,011805#03DC07,032006#08DD0B,072009"
                                               ,555,513,693,548,ril=RIL.TEXTLINE,
                                               lang='eng',oem=1,
                                               attribute=["tessedit_char_whitelist",
                                                "0123456789,"])
                            print(pos)
                            _x = int(pos['text'].split(',')[0])
                            _y = int(pos['text'].split(',')[1])
                            tu_list.append((data,_x,_y))
        return  tu_list  
    
    
    def go_to_CSC(self):
        status,ag= self.findMultiColorInRegionFuzzyByTable(feixingfu_jiemian)
        if status.OK:
            pass
            
    #前往长寿郊外
    def go_to_CSJW(self):
        pass
        
    def go_to_map_by_f():
        pass
        
    def Tothecountryside(self):
        self.click(1695,1015)
        time.sleep(1)
            
            
    
        

def main():
    #blRobot.Get_GameHwnd()
    start = time.time()
    Robot = action(zoom_count=1.0)
    map_list = Robot.check_map()
    end = time.time()
    print("Elapsed (with compilation) = %s" % (end - start))
    
if __name__ == "__main__":
    main()